class CacheManager{constructor(){this.CACHE_VERSION="v1.0.0",this.CACHE_PREFIX="krause_cache_",this.CACHE_DURATION={SHORT:3e5,MEDIUM:18e5,LONG:864e5,PERMANENT:null},this.initializeCache()}initializeCache(){localStorage.getItem("cache_version")!==this.CACHE_VERSION&&(this.clearAllCache(),localStorage.setItem("cache_version",this.CACHE_VERSION))}generateKey(e,t=null){const a=t?`_user_${t}`:"";return`${this.CACHE_PREFIX}${e}${a}`}set(e,t,a=this.CACHE_DURATION.MEDIUM,r=null){try{const o=this.generateKey(e,r),n={data:t,timestamp:Date.now(),duration:a,version:this.CACHE_VERSION};return localStorage.setItem(o,JSON.stringify(n)),!0}catch(e){return console.warn("Cache set failed:",e),this.clearExpiredCache(),!1}}get(e,t=null){try{const a=this.generateKey(e,t),r=localStorage.getItem(a);if(!r)return null;const o=JSON.parse(r);return o.version!==this.CACHE_VERSION||null!==o.duration&&Date.now()-o.timestamp>o.duration?(this.remove(e,t),null):o.data}catch(e){return console.warn("Cache get failed:",e),null}}remove(e,t=null){const a=this.generateKey(e,t);localStorage.removeItem(a)}clearExpiredCache(){const e=Date.now();Object.keys(localStorage).forEach(t=>{if(t.startsWith(this.CACHE_PREFIX))try{const a=JSON.parse(localStorage.getItem(t));null!==a.duration&&e-a.timestamp>a.duration&&localStorage.removeItem(t)}catch(e){localStorage.removeItem(t)}})}clearAllCache(){Object.keys(localStorage).forEach(e=>{e.startsWith(this.CACHE_PREFIX)&&localStorage.removeItem(e)})}clearUserCache(e){Object.keys(localStorage).forEach(t=>{t.includes(`_user_${e}`)&&localStorage.removeItem(t)})}getCacheStats(){const e=Object.keys(localStorage).filter(e=>e.startsWith(this.CACHE_PREFIX));let t=0,a=0,r=0;return e.forEach(e=>{const o=localStorage.getItem(e);t+=o.length;try{const e=JSON.parse(o);null!==e.duration&&Date.now()-e.timestamp>e.duration?a++:r++}catch(e){a++}}),{totalEntries:e.length,validEntries:r,expiredEntries:a,totalSize:(t/1024).toFixed(2)+" KB"}}}class APICache{constructor(e){this.cache=e,this.pendingRequests=new Map}async fetchWithCache(e,t={},a={}){const{identifier:r=e,duration:o=this.cache.CACHE_DURATION.MEDIUM,userId:n=null,forceRefresh:s=!1,showLoading:c=!0}=a;if(!s){const e=this.cache.get(r,n);if(e)return console.log("✅ Cache hit:",r),e}if(this.pendingRequests.has(r))return console.log("⏳ Request pending, waiting...:",r),this.pendingRequests.get(r);c&&this.showLoadingScreen(`Cargando ${r}...`);const i=fetch(e,t).then(e=>{if(!e.ok)throw new Error(`HTTP error! status: ${e.status}`);return e.json()}).then(e=>(this.cache.set(r,e,o,n),this.pendingRequests.delete(r),c&&this.hideLoadingScreen(),console.log("✅ Data fetched and cached:",r),e)).catch(e=>{throw console.error("❌ Fetch error:",e),this.pendingRequests.delete(r),c&&this.hideLoadingScreen(),e});return this.pendingRequests.set(r,i),i}showLoadingScreen(e){const t=encodeURIComponent(window.location.href);window.location.href=`loading.html?message=${encodeURIComponent(e)}&redirect=${t}`}hideLoadingScreen(){}}class FileManager{constructor(){this.maxFileSize=10485760,this.allowedTypes={documents:["pdf","doc","docx","txt"],images:["jpg","jpeg","png","gif","webp"],spreadsheets:["xls","xlsx","csv"]}}async uploadFile(e,t,a){return new Promise((r,o)=>{if(e.size>this.maxFileSize)return void o(new Error("El archivo excede el tamaño máximo permitido (10MB)"));const n=new FormData;n.append("file",e);const s=new XMLHttpRequest;s.upload.addEventListener("progress",e=>{if(e.lengthComputable){const t=Math.round(e.loaded/e.total*100);a&&a(t)}}),s.addEventListener("load",()=>{if(200===s.status)try{const e=JSON.parse(s.responseText);r(e)}catch(e){o(new Error("Error al procesar la respuesta del servidor"))}else o(new Error(`Error en la carga: ${s.statusText}`))}),s.addEventListener("error",()=>{o(new Error("Error de red al cargar el archivo"))}),s.open("POST",t),s.send(n)})}async downloadFile(e,t,a){try{const r=await fetch(e);if(!r.ok)throw new Error(`Error al descargar: ${r.statusText}`);const o=r.headers.get("content-length"),n=parseInt(o,10);let s=0;const c=r.body.getReader(),i=[];for(;;){const{done:e,value:t}=await c.read();if(e)break;i.push(t),s+=t.length,a&&n&&a(Math.round(s/n*100))}const l=new Blob(i),h=window.URL.createObjectURL(l),d=document.createElement("a");return d.href=h,d.download=t,document.body.appendChild(d),d.click(),document.body.removeChild(d),window.URL.revokeObjectURL(h),!0}catch(e){throw console.error("Download error:",e),e}}validateFileType(e,t){const a=e.split(".").pop().toLowerCase();return(this.allowedTypes[t]||[]).includes(a)}}const cacheManager=new CacheManager,apiCache=new APICache(cacheManager),fileManager=new FileManager;"undefined"!=typeof module&&module.exports&&(module.exports={CacheManager,APICache,FileManager,cacheManager,apiCache,fileManager});